//>>built
define("dijit/_editor/plugins/EnterKeyHandling",["dojo/_base/declare","dojo/dom-construct","dojo/keys","dojo/_base/lang","dojo/on","dojo/sniff","dojo/_base/window","dojo/window","../_Plugin","../RichText","../range"],function(_1,_2,_3,_4,on,_5,_6,_7,_8,_9,_a){return _1("dijit._editor.plugins.EnterKeyHandling",_8,{blockNodeForEnter:"BR",constructor:function(_b){if(_b){if("blockNodeForEnter" in _b){_b.blockNodeForEnter=_b.blockNodeForEnter.toUpperCase();}_4.mixin(this,_b);}},setEditor:function(_c){if(this.editor===_c){return;}this.editor=_c;if(this.blockNodeForEnter=="BR"){this.editor.customUndo=true;_c.onLoadDeferred.then(_4.hitch(this,function(d){this.own(on(_c.document,"keydown",_4.hitch(this,function(e){if(e.keyCode==_3.ENTER){var ne=_4.mixin({},e);ne.shiftKey=true;if(!this.handleEnterKey(ne)){e.stopPropagation();e.preventDefault();}}})));if(_5("ie")>=9){this.own(on(_c.document,"paste",_4.hitch(this,function(e){setTimeout(_4.hitch(this,function(){var r=this.editor.document.selection.createRange();r.move("character",-1);r.select();r.move("character",1);r.select();}),0);})));}return d;}));}else{if(this.blockNodeForEnter){var h=_4.hitch(this,"handleEnterKey");_c.addKeyHandler(13,0,0,h);_c.addKeyHandler(13,0,1,h);this.own(this.editor.on("KeyPressed",_4.hitch(this,"onKeyPressed")));}}},onKeyPressed:function(){if(this._checkListLater){if(this.editor.selection.isCollapsed()){var _d=this.editor.selection.getAncestorElement("LI");if(!_d){_9.prototype.execCommand.call(this.editor,"formatblock",this.blockNodeForEnter);var _e=this.editor.selection.getAncestorElement(this.blockNodeForEnter);if(_e){_e.innerHTML=this.bogusHtmlContent;if(_5("ie")<=9){var r=this.editor.document.selection.createRange();r.move("character",-1);r.select();}}else{console.error("onKeyPressed: Cannot find the new block node");}}else{if(_5("mozilla")){if(_d.parentNode.parentNode.nodeName=="LI"){_d=_d.parentNode.parentNode;}}var fc=_d.firstChild;if(fc&&fc.nodeType==1&&(fc.nodeName=="UL"||fc.nodeName=="OL")){_d.insertBefore(fc.ownerDocument.createTextNode(" "),fc);var _f=_a.create(this.editor.window);_f.setStart(_d.firstChild,0);var _10=_a.getSelection(this.editor.window,true);_10.removeAllRanges();_10.addRange(_f);}}}this._checkListLater=false;}if(this._pressedEnterInBlock){if(this._pressedEnterInBlock.previousSibling){this.removeTrailingBr(this._pressedEnterInBlock.previousSibling);}delete this._pressedEnterInBlock;}},bogusHtmlContent:"&#160;",blockNodes:/^(?:P|H1|H2|H3|H4|H5|H6|LI)$/,handleEnterKey:function(e){var _11,_12,_13,_14,_15,_16,doc=this.editor.document,br,rs,txt;if(e.shiftKey){var _17=this.editor.selection.getParentElement();var _18=_a.getAncestor(_17,this.blockNodes);if(_18){if(_18.tagName=="LI"){return true;}_11=_a.getSelection(this.editor.window);_12=_11.getRangeAt(0);if(!_12.collapsed){_12.deleteContents();_11=_a.getSelection(this.editor.window);_12=_11.getRangeAt(0);}if(_a.atBeginningOfContainer(_18,_12.startContainer,_12.startOffset)){br=doc.createElement("br");_13=_a.create(this.editor.window);_18.insertBefore(br,_18.firstChild);_13.setStartAfter(br);_11.removeAllRanges();_11.addRange(_13);}else{if(_a.atEndOfContainer(_18,_12.startContainer,_12.startOffset)){_13=_a.create(this.editor.window);br=doc.createElement("br");_18.appendChild(br);_18.appendChild(doc.createTextNode(" "));_13.setStart(_18.lastChild,0);_11.removeAllRanges();_11.addRange(_13);}else{rs=_12.startContainer;if(rs&&rs.nodeType==3){txt=rs.nodeValue;_14=doc.createTextNode(txt.substring(0,_12.startOffset));_15=doc.createTextNode(txt.substring(_12.startOffset));_16=doc.createElement("br");if(_15.nodeValue==""&&_5("webkit")){_15=doc.createTextNode(" ");}_2.place(_14,rs,"after");_2.place(_16,_14,"after");_2.place(_15,_16,"after");_2.destroy(rs);_13=_a.create(this.editor.window);_13.setStart(_15,0);_11.removeAllRanges();_11.addRange(_13);return false;}return true;}}}else{_11=_a.getSelection(this.editor.window);if(_11.rangeCount){_12=_11.getRangeAt(0);if(_12&&_12.startContainer){if(!_12.collapsed){_12.deleteContents();_11=_a.getSelection(this.editor.window);_12=_11.getRangeAt(0);}rs=_12.startContainer;if(rs&&rs.nodeType==3){var _19=false;var _1a=_12.startOffset;if(rs.length<_1a){ret=this._adjustNodeAndOffset(rs,_1a);rs=ret.node;_1a=ret.offset;}txt=rs.nodeValue;_14=doc.createTextNode(txt.substring(0,_1a));_15=doc.createTextNode(txt.substring(_1a));_16=doc.createElement("br");if(!_15.length){_15=doc.createTextNode(" ");_19=true;}if(_14.length){_2.place(_14,rs,"after");}else{_14=rs;}_2.place(_16,_14,"after");_2.place(_15,_16,"after");_2.destroy(rs);_13=_a.create(this.editor.window);_13.setStart(_15,0);_13.setEnd(_15,_15.length);_11.removeAllRanges();_11.addRange(_13);if(_19&&!_5("webkit")){this.editor.selection.remove();}else{this.editor.selection.collapse(true);}}else{var _1b;if(_12.startOffset>=0){_1b=rs.childNodes[_12.startOffset];}var _16=doc.createElement("br");var _15=doc.createTextNode(" ");if(!_1b){rs.appendChild(_16);rs.appendChild(_15);}else{_2.place(_16,_1b,"before");_2.place(_15,_16,"after");}_13=_a.create(this.editor.window);_13.setStart(_15,0);_13.setEnd(_15,_15.length);_11.removeAllRanges();_11.addRange(_13);this.editor.selection.collapse(true);}}}else{_9.prototype.execCommand.call(this.editor,"inserthtml","<br>");}}return false;}var _1c=true;_11=_a.getSelection(this.editor.window);_12=_11.getRangeAt(0);if(!_12.collapsed){_12.deleteContents();_11=_a.getSelection(this.editor.window);_12=_11.getRangeAt(0);}var _1d=_a.getBlockAncestor(_12.endContainer,null,this.editor.editNode);var _1e=_1d.blockNode;if((this._checkListLater=(_1e&&(_1e.nodeName=="LI"||_1e.parentNode.nodeName=="LI")))){if(_5("mozilla")){this._pressedEnterInBlock=_1e;}if(/^(\s|&nbsp;|&#160;|\xA0|<span\b[^>]*\bclass=['"]Apple-style-span['"][^>]*>(\s|&nbsp;|&#160;|\xA0)<\/span>)?(<br>)?$/.test(_1e.innerHTML)){_1e.innerHTML="";if(_5("webkit")){_13=_a.create(this.editor.window);_13.setStart(_1e,0);_11.removeAllRanges();_11.addRange(_13);}this._checkListLater=false;}return true;}if(!_1d.blockNode||_1d.blockNode===this.editor.editNode){try{_9.prototype.execCommand.call(this.editor,"formatblock",this.blockNodeForEnter);}catch(e2){}_1d={blockNode:this.editor.selection.getAncestorElement(this.blockNodeForEnter),blockContainer:this.editor.editNode};if(_1d.blockNode){if(_1d.blockNode!=this.editor.editNode&&(!(_1d.blockNode.textContent||_1d.blockNode.innerHTML).replace(/^\s+|\s+$/g,"").length)){this.removeTrailingBr(_1d.blockNode);return false;}}else{_1d.blockNode=this.editor.editNode;}_11=_a.getSelection(this.editor.window);_12=_11.getRangeAt(0);}var _1f=doc.createElement(this.blockNodeForEnter);_1f.innerHTML=this.bogusHtmlContent;this.removeTrailingBr(_1d.blockNode);var _20=_12.endOffset;var _21=_12.endContainer;if(_21.length<_20){var ret=this._adjustNodeAndOffset(_21,_20);_21=ret.node;_20=ret.offset;}if(_a.atEndOfContainer(_1d.blockNode,_21,_20)){if(_1d.blockNode===_1d.blockContainer){_1d.blockNode.appendChild(_1f);}else{_2.place(_1f,_1d.blockNode,"after");}_1c=false;_13=_a.create(this.editor.window);_13.setStart(_1f,0);_11.removeAllRanges();_11.addRange(_13);if(this.editor.height){_7.scrollIntoView(_1f);}}else{if(_a.atBeginningOfContainer(_1d.blockNode,_12.startContainer,_12.startOffset)){_2.place(_1f,_1d.blockNode,_1d.blockNode===_1d.blockContainer?"first":"before");if(_1f.nextSibling&&this.editor.height){_13=_a.create(this.editor.window);_13.setStart(_1f.nextSibling,0);_11.removeAllRanges();_11.addRange(_13);_7.scrollIntoView(_1f.nextSibling);}_1c=false;}else{if(_1d.blockNode===_1d.blockContainer){_1d.blockNode.appendChild(_1f);}else{_2.place(_1f,_1d.blockNode,"after");}_1c=false;if(_1d.blockNode.style){if(_1f.style){if(_1d.blockNode.style.cssText){_1f.style.cssText=_1d.blockNode.style.cssText;}}}rs=_12.startContainer;var _22;if(rs&&rs.nodeType==3){var _23,_24;_20=_12.endOffset;if(rs.length<_20){ret=this._adjustNodeAndOffset(rs,_20);rs=ret.node;_20=ret.offset;}txt=rs.nodeValue;_14=doc.createTextNode(txt.substring(0,_20));_15=doc.createTextNode(txt.substring(_20,txt.length));_2.place(_14,rs,"before");_2.place(_15,rs,"after");_2.destroy(rs);var _25=_14.parentNode;while(_25!==_1d.blockNode){var tg=_25.tagName;var _26=doc.createElement(tg);if(_25.style){if(_26.style){if(_25.style.cssText){_26.style.cssText=_25.style.cssText;}}}if(_25.tagName==="FONT"){if(_25.color){_26.color=_25.color;}if(_25.face){_26.face=_25.face;}if(_25.size){_26.size=_25.size;}}_23=_15;while(_23){_24=_23.nextSibling;_26.appendChild(_23);_23=_24;}_2.place(_26,_25,"after");_14=_25;_15=_26;_25=_25.parentNode;}_23=_15;if(_23.nodeType==1||(_23.nodeType==3&&_23.nodeValue)){_1f.innerHTML="";}_22=_23;while(_23){_24=_23.nextSibling;_1f.appendChild(_23);_23=_24;}}_13=_a.create(this.editor.window);var _27;var _28=_22;if(this.blockNodeForEnter!=="BR"){while(_28){_27=_28;_24=_28.firstChild;_28=_24;}if(_27&&_27.parentNode){_1f=_27.parentNode;_13.setStart(_1f,0);_11.removeAllRanges();_11.addRange(_13);if(this.editor.height){_7.scrollIntoView(_1f);}if(_5("mozilla")){this._pressedEnterInBlock=_1d.blockNode;}}else{_1c=true;}}else{_13.setStart(_1f,0);_11.removeAllRanges();_11.addRange(_13);if(this.editor.height){_7.scrollIntoView(_1f);}if(_5("mozilla")){this._pressedEnterInBlock=_1d.blockNode;}}}}return _1c;},_adjustNodeAndOffset:function(_29,_2a){while(_29.length<_2a&&_29.nextSibling&&_29.nextSibling.nodeType==3){_2a=_2a-_29.length;_29=_29.nextSibling;}return {"node":_29,"offset":_2a};},removeTrailingBr:function(_2b){var _2c=/P|DIV|LI/i.test(_2b.tagName)?_2b:this.editor.selection.getParentOfType(_2b,["P","DIV","LI"]);if(!_2c){return;}if(_2c.lastChild){if((_2c.childNodes.length>1&&_2c.lastChild.nodeType==3&&/^[\s\xAD]*$/.test(_2c.lastChild.nodeValue))||_2c.lastChild.tagName=="BR"){_2.destroy(_2c.lastChild);}}if(!_2c.childNodes.length){_2c.innerHTML=this.bogusHtmlContent;}}});});