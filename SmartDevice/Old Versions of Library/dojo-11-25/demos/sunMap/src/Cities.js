//>>built
define("demos/sunMap/src/Cities",["dojo/_base/kernel","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/xhr","dijit/Tooltip","dojox/geo/openlayers/GfxLayer","dojox/geo/openlayers/Point","dojox/geo/openlayers/GeometryFeature","dojox/gfx","dojox/gfx/move","dojox/gfx/fx","dojo/fx","dojo/has"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,fx,_d){_a.Text.prototype.getBoundingBox=function(){if(_d("ie")){return this.getShape();}return this.rawNode.getBBox();};return _2(null,{constructor:function(_e){this.sunDemo=_e;this.pop=_d("ie")?10000000:1000000;this.minPop=Math.pow(2,30);this.maxPop=0;this.readCSV("cities.csv",_3.hitch(this,this.loaded));this._circles=false;this._gradients=false;var _f=new _7("cities");var map=this.sunDemo.map;map.map.addLayer(_f);this.layer=_f;},useGradients:function(u){if(u==undefined){return this._gradients;}this._gradients=u;this.updateCities();return u;},useCircles:function(u){if(u==undefined){return this._circles;}this._circles=u;this.updateCities(true);return u;},loaded:function(res){var _10=this.layer;_4.forEach(res,function(o){var p={x:parseFloat(o.longitude),y:parseFloat(o.latitude)};var pg=new _8(p);var f=new _9(pg);this.setCreateShape(f,o);var r=o.population;var dp=this.maxPop-this.minPop;if(dp!=0){r=(r-this.minPop+100)*20/dp;}else{r=20;}if(this._circles){f.setShapeProperties({r:r});}else{f.setShapeProperties({x:-r/2,y:-r/2,width:r,height:r,r:0});}_10.addFeature(f);f.getShape();this.connectTooltip(pg,o.asciiname,r);},this);_10.redraw();this.updateCities();},updateCities:function(_11){if(!this.layer){return;}var _12=this.layer.getFeatures();var gf=this.sunDemo.getTZone();var tz=gf._geometry.coordinates;var _13=function(p){var _14=tz.length;var j=_14-1;var _15=false;var x=p.x;var y=p.y;for(var i=0;i<_14;i++){var o=tz[i];var xi=o.x;var yi=o.y;o=tz[j];var xj=o.x;var yj=o.y;if(yi<y&&yj>=y||yj<y&&yi>=y){if(xi+(y-yi)/(yj-yi)*(xj-xi)<x){_15=!_15;}}j=i;o=tz[j];xj=o.x;yj=o.y;}return _15;};_4.forEach(_12,function(f){var g=f._geometry.coordinates;var p=f.getShapeProperties();var r=p.r|p.width;if(_11){f.remove();if(this._circles){f.setShapeProperties({r:r});}else{f.setShapeProperties({x:-r/2,y:-r/2,width:r,height:r,r:0});}}if(_13(g)){f.setStroke("black");if(this._gradients){f.setFill({type:"radial",r:r,colors:[{offset:0,color:[255,255,255]},{offset:1,color:[0,0,0]}]});}else{f.setFill([0,0,0,0]);}}else{f.setStroke([0,128,128]);if(this._gradients){f.setFill({type:"radial",r:r,colors:[{offset:0,color:[255,255,255]},{offset:1,color:[255,255,0]}]});}else{f.setFill("yellow");}}},this);this.layer.redraw();},readCSV:function(url,cb){_5.get({url:url,handleAs:"text",nocache:true,noCache:true,load:_3.hitch(this,function(_16){var _17=["asciiname","longitude","latitude","population"];var res=this.parseCSV(_16,_17,_3.hitch(this,function(_18,_19){var _1a=_4.indexOf(_18,"population");var pop=_19[_1a];pop=parseInt(pop);var ok=pop>this.pop;if(ok){if(pop<this.minPop){this.minPop=pop;}if(pop>this.maxPop){this.maxPop=pop;}}return ok;}));cb(res);}),error:function(e){},headers:{content:"text/html; charset=UTF-8"}});},parseCSV:function(s,_1b,_1c){var res=[];var nl="\n";var sep="\t";var _1d=0;var eol=s.indexOf(nl,_1d);var _1e=s.substring(_1d,eol);var _1f=_1e.split(sep);var re=/^\"(.*)\"$/;_4.forEach(_1f,function(h,_20){var r=re.exec(h);if(r&&r.length>1){_1f[_20]=r[1];}});_1d=eol+1;var _21=0;while((eol=s.indexOf(nl,_1d))!=-1){_1e=s.substring(_1d,eol);var _22=_1e.split(sep);if(_1c==undefined||_1c(_1f,_22)){var o={};_4.forEach(_1b,function(w,i){index=_4.indexOf(_1f,w);var _23=_22[index];var r=re.exec(_23);if(r&&r.length>1){_23=r[1];}o[w]=_23;});res.push(o);_21++;}_1d=eol+1;}return res;},setCreateShape:function(_24,_25){var _26=_3.hitch(this,function(_27){var _28;if(this._circles){_28=_27.createCircle();}else{_28=_27.createRect();}return _28;});_24.createShape=_26;},connectTooltip:function(g,_29,_2a){var map=this.sunDemo.map.map;var _2b=function(p){var x=p.x;var y=p.y;var _2c=map.olMap.baseLayer;var _2d=map.olMap.getResolution();var _2e=_2c.getExtent();var rx=(x/_2d+(-_2e.left/_2d));var ry=((_2e.top/_2d)-y/_2d);return [rx,ry];};g.shape.connect("onmouseover",function(){var p=_3.mixin({},g.coordinates);p=map.transform(p);var a=_2b(p);var r={x:a[0],y:a[1],w:_2a,h:_2a};var s=g.shape;_3.mixin(s,r);_6.show(_29,s,["after"]);});g.shape.connect("onmouseout",function(){_6.hide(g.shape);});}});});