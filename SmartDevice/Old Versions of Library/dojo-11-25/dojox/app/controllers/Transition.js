//>>built
define("dojox/app/controllers/Transition",["require","dojo/_base/lang","dojo/_base/declare","dojo/has","dojo/on","dojo/Deferred","dojo/when","dojo/dom-style","../Controller","../utils/constraints"],function(_1,_2,_3,_4,on,_5,_6,_7,_8,_9){var _a;var _b="app/controllers/Transition";var _c="logTransitions:";return _3("dojox.app.controllers.Transition",_8,{proceeding:false,waitingQueue:[],constructor:function(_d,_e){this.events={"app-transition":this.transition,"app-domNode":this.onDomNodeChange};_1([this.app.transit||"dojox/css3/transit"],function(t){_a=t;});if(this.app.domNode){this.onDomNodeChange({oldNode:null,newNode:this.app.domNode});}},transition:function(_f){var F=_b+":transition";this.app.log(_c,F,"New Transition event.viewId=["+_f.viewId+"]");this.app.log(F,"event.viewId=["+_f.viewId+"]","event.opts=",_f.opts);var _10=_f.viewId||"";this.proceedingSaved=this.proceeding;var _11=_10.split("+");var _12=_10.split("-");var _13,_14;if(_11.length>0||_12.length>0){while(_11.length>1){_13=_11.shift();_14=_2.clone(_f);_14.viewId=_13;this.proceeding=true;_14._removeView=false;this.proceedTransition(_14);}_13=_11.shift();var _15=_13.split("-");if(_15.length>0){_13=_15.shift();}if(_13.length>0){this.proceeding=this.proceedingSaved;_f.viewId=_13;_f._doResize=true;_f._removeView=false;this.proceedTransition(_f);}if(_15.length>0){while(_15.length>0){var _16=_15.shift();_14=_2.clone(_f);_14.viewId=_16;_14._removeView=true;_14._doResize=true;this.proceedTransition(_14);}}}else{_f._doResize=true;_f._removeView=false;this.proceedTransition(_f);}},onDomNodeChange:function(evt){if(evt.oldNode!=null){this.unbind(evt.oldNode,"startTransition");}this.bind(evt.newNode,"startTransition",_2.hitch(this,this.onStartTransition));},onStartTransition:function(evt){if(evt.preventDefault){evt.preventDefault();}evt.cancelBubble=true;if(evt.stopPropagation){evt.stopPropagation();}var _17=evt.detail.target;var _18=/#(.+)/;if(!_17&&_18.test(evt.detail.href)){_17=evt.detail.href.match(_18)[1];}this.transition({"viewId":_17,opts:_2.mixin({},evt.detail),data:evt.detail.data});},proceedTransition:function(_19){var F=_b+":proceedTransition";if(this.proceeding){this.app.log(F+" push event",_19);this.waitingQueue.push(_19);this.processingQueue=false;return;}this.app.log(F+" this.waitingQueue.length ="+this.waitingQueue.length+" this.processingQueue="+this.processingQueue);if(this.waitingQueue.length>0&&!this.processingQueue){this.processingQueue=true;this.app.log(F+" push event past proceeding",_19);this.waitingQueue.push(_19);_19=this.waitingQueue.shift();this.app.log(F+" shifted waitingQueue to process",_19);}this.proceeding=true;this.app.log(F+" calling trigger load",_19);if(!_19.opts){_19.opts={};}var _1a=_19.params||_19.opts.params;this.app.emit("app-load",{"viewId":_19.viewId,"params":_1a,"callback":_2.hitch(this,function(){var _1b=this._doTransition(_19.viewId,_19.opts,_1a,_19.opts.data,this.app,_19._removeView,_19._doResize);_6(_1b,_2.hitch(this,function(){this.proceeding=false;this.processingQueue=true;var _1c=this.waitingQueue.shift();if(_1c){this.proceedTransition(_1c);}}));})});},_getTransition:function(_1d,_1e,_1f,_20){var _21=_1e;var _22=null;if(_1d){_22=_1d.transition;}if(!_22&&_21.views[_1f]){_22=_21.views[_1f].transition;}if(!_22){_22=_21.transition;}var _23=(_1d&&_1d.defaultTransition)?_1d.defaultTransition:_21.defaultTransition;while(!_22&&_21.parent){_21=_21.parent;_22=_21.transition;if(!_23){_23=_21.defaultTransition;}}return _22||_20.transition||_23||"none";},_getParamsForView:function(_24,_25){var _26={};for(var _27 in _25){var _28=_25[_27];if(_2.isObject(_28)){if(_27==_24){_26=_2.mixin(_26,_28);}}else{if(_27&&_28!=null){_26[_27]=_25[_27];}}}return _26;},_doTransition:function(_29,_2a,_2b,_2c,_2d,_2e,_2f,_30){var F=_b+":_doTransition";if(!_2d){throw Error("view parent not found in transition.");}this.app.log(F+" transitionTo=[",_29,"], removeView=[",_2e,"] parent.name=[",_2d.name,"], opts=",_2a);var _31,_32,_33,_34;if(_29){_31=_29.split(",");}else{_31=_2d.defaultView.split(",");}_32=_31.shift();_33=_31.join(",");_34=_2d.children[_2d.id+"_"+_32];if(!_34){if(_2e){this.app.log(F+" called with removeView true, but that view is not available to remove");return;}throw Error("child view must be loaded before transition.");}if(!_33&&_34.defaultView){_33=_34.defaultView;}var _35=[_34||_2d];if(_33){_35=this._getNextSubViewArray(_33,_34,_2d);}var _36=_9.getSelectedChild(_2d,_34.constraint);var _37=this._getCurrentSubViewArray(_2d,_35,_2e);var _38=this._getCurrentSubViewNamesArray(_37);_34.params=this._getParamsForView(_34.name,_2b);if(_2e){if(_34!==_36){this.app.log(F+" called with removeView true, but that view is not available to remove");return;}this.app.log(_c,F,"Transition Remove current From=["+_38+"]");_34=null;}var _39="";if(_34){_39=_34.name;if(_33){_39=_39+","+_33;}}if(_39==_38&&_34==_36){this.app.log(_c,F,"Transition current and next DO MATCH From=["+_38+"] TO=["+_39+"]");this._handleMatchingViews(_35,_34,_36,_2d,_2c,_2e,_2f,_33,_38);}else{this.app.log(_c,F,"Transition current and next DO NOT MATCH From=["+_38+"] TO=["+_39+"]");if(_36&&_36._active){this._handleBeforeDeactivateCalls(_37,this.nextLastSubChildMatch||_34,_36,_2c,_33);}if(_34){this.app.log(F+" calling _handleBeforeActivateCalls next name=[",_34.name,"], parent.name=[",_34.parent.name,"]");this._handleBeforeActivateCalls(_35,this.currentLastSubChildMatch||_36,_2c,_33);}if(!_2e){this.app.log(F+" calling _handleLayoutAndResizeCalls");this._handleLayoutAndResizeCalls(_35,_2e,_2f,_33);}var _3a=true;if(_a&&(!_30||this.currentLastSubChildMatch!=null)&&this.currentLastSubChildMatch!==_34){_3a=this._handleTransit(_34,_2d,this.currentLastSubChildMatch,_2a,_32,_2e);}_6(_3a,_2.hitch(this,function(){if(_34){this.app.log(F+" back from transit for next ="+_34.name);}if(_2e){this._handleLayoutAndResizeCalls(_35,_2e,_2f,_33);}this._handleAfterDeactivateCalls(_37,this.nextLastSubChildMatch||_34,_36,_2c,_33);this._handleAfterActivateCalls(_35,_2e,this.currentLastSubChildMatch||_36,_2c,_33);}));return _3a;}},_handleMatchingViews:function(_3b,_3c,_3d,_3e,_3f,_40,_41,_42,_43){var F=_b+":_handleMatchingViews";this._handleBeforeDeactivateCalls(_3b,this.nextLastSubChildMatch||_3c,_3d,_3f,_42);this._handleAfterDeactivateCalls(_3b,this.nextLastSubChildMatch||_3c,_3d,_3f,_42);this._handleBeforeActivateCalls(_3b,this.currentLastSubChildMatch||_3d,_3f,_42);this._handleLayoutAndResizeCalls(_3b,_40,_41,_42);this._handleAfterActivateCalls(_3b,_40,this.currentLastSubChildMatch||_3d,_3f,_42);},_handleBeforeDeactivateCalls:function(_44,_45,_46,_47,_48){var F=_b+":_handleBeforeDeactivateCalls";if(_46._active){for(var i=_44.length-1;i>=0;i--){var v=_44[i];if(v&&v.beforeDeactivate&&v._active){this.app.log(_c,F,"beforeDeactivate for v.id="+v.id);v.beforeDeactivate(_45,_47);}}}},_handleAfterDeactivateCalls:function(_49,_4a,_4b,_4c,_4d){var F=_b+":_handleAfterDeactivateCalls";if(_4b&&_4b._active){for(var i=0;i<_49.length;i++){var v=_49[i];if(v&&v.beforeDeactivate&&v._active){this.app.log(_c,F,"afterDeactivate for v.id="+v.id);v.afterDeactivate(_4a,_4c);v._active=false;}}}},_handleBeforeActivateCalls:function(_4e,_4f,_50,_51){var F=_b+":_handleBeforeActivateCalls";for(var i=_4e.length-1;i>=0;i--){var v=_4e[i];this.app.log(_c,F,"beforeActivate for v.id="+v.id);v.beforeActivate(_4f,_50);}},_handleLayoutAndResizeCalls:function(_52,_53,_54,_55){var F=_b+":_handleLayoutAndResizeCalls";var _56=_53;for(var i=0;i<_52.length;i++){var v=_52[i];this.app.log(_c,F,"emit layoutView v.id=["+v.id+"] removeView=["+_56+"]");this.app.emit("app-layoutView",{"parent":v.parent,"view":v,"removeView":_56,"doResize":false});_56=false;}if(_54){this.app.log(_c,F,"emit doResize called");this.app.emit("app-resize");}},_handleAfterActivateCalls:function(_57,_58,_59,_5a,_5b){var F=_b+":_handleAfterActivateCalls";var _5c=0;if(_58&&_57.length>1){_5c=1;}for(var i=_5c;i<_57.length;i++){var v=_57[i];if(v.afterActivate){this.app.log(_c,F,"afterActivate for v.id="+v.id);v.afterActivate(_59,_5a);v._active=true;}}},_getNextSubViewArray:function(_5d,_5e,_5f){var F=_b+":_getNextSubViewArray";var _60=[];var p=_5e||_5f;if(_5d){_60=_5d.split(",");}var _61=[p];for(var i=0;i<_60.length;i++){toId=_60[i];var v=p.children[p.id+"_"+toId];if(v){_61.push(v);p=v;}}_61.reverse();return _61;},_getCurrentSubViewArray:function(_62,_63,_64){var F=_b+":_getCurrentSubViewArray";var _65=[];var _66,_67,_68;var p=_62;this.currentLastSubChildMatch=null;this.nextLastSubChildMatch=null;for(var i=_63.length-1;i>=0;i--){_66=_63[i].constraint;_67=typeof (_66);_68=(_67=="string"||_67=="number")?_66:_66.__hash;if(p&&p.selectedChildren&&p.selectedChildren[_68]){if(p.selectedChildren[_68]==_63[i]){this.currentLastSubChildMatch=p.selectedChildren[_68];this.nextLastSubChildMatch=_63[i];_65.push(this.currentLastSubChildMatch);p=this.currentLastSubChildMatch;}else{this.currentLastSubChildMatch=p.selectedChildren[_68];_65.push(this.currentLastSubChildMatch);this.nextLastSubChildMatch=_63[i];if(!_64){var _69=_9.getAllSelectedChildren(this.currentLastSubChildMatch);_65=_65.concat(_69);}break;}}else{this.currentLastSubChildMatch=null;this.nextLastSubChildMatch=_63[i];break;}}if(_64){var _69=_9.getAllSelectedChildren(p);_65=_65.concat(_69);}return _65;},_getCurrentSubViewNamesArray:function(_6a){var F=_b+":_getCurrentSubViewNamesArray";var _6b=[];for(var i=0;i<_6a.length;i++){_6b.push(_6a[i].name);}return _6b;},_handleTransit:function(_6c,_6d,_6e,_6f,_70,_71){var F=_b+":_handleTransit";var _72=this.nextLastSubChildMatch||_6c;var _73=_2.mixin({},_6f);_73=_2.mixin({},_73,{reverse:(_73.reverse||_73.transitionDir===-1)?true:false,transition:this._getTransition(_72,_6d,_70,_73)});if(_71){_72=null;}if(_6e){this.app.log(_c,F,"transit FROM currentLastSubChild.id=["+_6e.id+"]");}if(_72){this.app.log(_c,F,"transit TO nextLastSubChild.id=["+_72.id+"] transition=["+_73.transition+"]");}return _a(_6e&&_6e.domNode,_72&&_72.domNode,_73);}});});